{% extends "base.html" %}
{% block content %}
<div class="container container-int">
  

  <form id="checkoutForm" class="needs-validation form-ticket" novalidate>
    <h1>Finaliza tu reserva — {{ event.nombre }}</h1>
    {% csrf_token %}
    <div class="row g-3 mt-3">
      <!-- Datos personales -->
      <div class="col-md-6">
        <label class="form-label">Nombres *</label>
        <input id="nombres" class="form-control" required>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Apellido paterno *</label>
        <input id="apellido1" class="form-control" required>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Apellido materno</label>
        <input id="apellido2" class="form-control">
      </div>

      <!-- Contacto -->
      <div class="col-md-6">
        <label class="form-label">Email *</label>
        <input id="email" type="email" class="form-control" required>
        <div class="invalid-feedback">Email inválido.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Confirmar email *</label>
        <input id="email2" type="email" class="form-control" required>
        <div class="invalid-feedback">Los emails no coinciden.</div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Teléfono móvil *</label>
        <input id="telefono" class="form-control" inputmode="numeric" pattern="\d{8,}" required>
        <div class="invalid-feedback">Solo números, al menos 8 dígitos.</div>
      </div>

      <!-- Documento -->
      <div class="col-md-2">
        <label class="form-label d-block">Tipo doc.</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="doc_tipo" id="doc_tipo_rut" value="rut" checked>
          <label class="form-check-label">RUT</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="doc_tipo" id="doc_tipo_passport" value="passport">
          <label class="form-check-label">Pasaporte</label>
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Número documento *</label>
        <input id="documento" class="form-control" required>
        <div class="invalid-feedback">Número de documento inválido.</div>
      </div>

      <!-- Ubicación -->
      <div class="col-md-6">
        <label class="form-label">País *</label>
        <select id="pais" class="form-select" required>
          <option value="">— Selecciona —</option>
          <option value="CL">Chile</option>
          <option value="AR">Argentina</option>
          <option value="PE">Perú</option>
          <option value="BR">Brasil</option>
          <option value="US">Estados Unidos</option>
          <option value="OTRO">Otro</option>
        </select>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>

      <div class="col-md-6" id="wrap-region" style="display:none;">
        <label class="form-label">Región *</label>
        <select id="region" class="form-select">
          <option value="">— Selecciona —</option>
        </select>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Ciudad *</label>
        <select id="ciudad" class="form-select" required>
          <option value="">— Selecciona —</option>
        </select>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Comuna *</label>
        <select id="comuna" class="form-select" required>
          <option value="">— Selecciona —</option>
        </select>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>

      <!-- Empresa -->
      <div class="col-md-6">
        <label class="form-label">Empresa / Institución *</label>
        <input id="empresa" class="form-control" required>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Cargo *</label>
        <input id="cargo" class="form-control" required>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Rubro *</label>
        <input id="rubro" class="form-control" required>
        <div class="invalid-feedback">Campo obligatorio.</div>
      </div>

      <!-- Patente: aparece solo si compró estacionamiento -->
      <div class="col-md-6" id="wrap-patente" style="display:none;">
        <label class="form-label">Patente del vehículo *</label>
        <input id="patente" class="form-control">
        <div class="invalid-feedback">Obligatorio si agregaste Estacionamiento.</div>
      </div>


      <!-- Checkboxes -->
      <div class="col-12 mt-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="acepta_terms" required>
          <label class="form-check-label">
            Acepto los <a href="#">Términos y Condiciones</a> y autorizo el tratamiento de mis datos personales.
          </label>
          <div class="invalid-feedback">Debes aceptar para continuar.</div>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="acepta_news">
          <label class="form-check-label">Deseo recibir noticias y beneficios.</label>
        </div>
      </div>
    </div>

    <p class="text-muted mt-3"><strong>*</strong> Campos obligatorios.</p>

    <!-- Footer -->
    <div class="d-flex justify-content-between align-items-center mt-4 border-top pt-3">
      <p><strong>SUBTOTAL:</strong> <span id="subtotalStep3">$0</span></p>
      <div>
        <a href="{% url 'orders:public-checkout-step1' event.slug %}" class="btn btn-secondary a-site">Atrás</a>
        <button id="btn-pagar" class="btn btn-primary btn-site" type="submit">PAGAR</button>
      </div>
    </div>
  </form>
</div>

<!-- ========== ESTILOS VALIDACIÓN ========== -->
<style>
/* Ocultas por defecto */
.invalid-feedback { display: none; }

/* Mostrar mensajes SOLO cuando el campo está inválido */
input.touched:invalid ~ .invalid-feedback,
select.touched:invalid ~ .invalid-feedback,
textarea.touched:invalid ~ .invalid-feedback,
.was-validated input:invalid ~ .invalid-feedback,
.was-validated select:invalid ~ .invalid-feedback,
.was-validated textarea:invalid ~ .invalid-feedback { display: block; }

/* Borde rojo solo si el propio campo está inválido */
input.touched:invalid, select.touched:invalid, textarea.touched:invalid {
  border-color: #dc3545;
}
</style>

<!-- ========== SCRIPT FORMULARIO ========== -->
<script>
(() => {
  const $ = id => document.getElementById(id);
  const form = $('checkoutForm');
  const pagar = $('btn-pagar');
  const money = n => (n||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});
  const BUYER_FROM_SERVER = {{ buyer_json|default:"null"|safe }};

  // === Validador de RUT chileno (módulo 11) ===
  function validarRutChileno(rutRaw) {
    if (!rutRaw) return false;
    let rut = rutRaw.replace(/\./g, "").replace(/\s/g, "").toUpperCase();

    if (!rut.includes("-")) return false;
    const [cuerpo, dv] = rut.split("-");

    if (!/^\d+$/.test(cuerpo)) return false;
    if (!/^[0-9K]$/.test(dv)) return false;

    const reversed = cuerpo.split("").reverse().map(d => parseInt(d, 10));
    const factors = [2, 3, 4, 5, 6, 7];

    let suma = 0;
    let fi = 0;

    for (const d of reversed) {
      suma += d * factors[fi];
      fi = (fi + 1) % factors.length;
    }

    const resto = 11 - (suma % 11);
    let dvEsperado;
    if (resto === 11) dvEsperado = "0";
    else if (resto === 10) dvEsperado = "K";
    else dvEsperado = String(resto);

    return dv === dvEsperado;
  }

  // === Autorellenar con datos de la cuenta (si el usuario está logueado) ===
  fetch("/accounts/api/profile/", {
    credentials: "include"
  })
  .then(r => r.ok ? r.json() : null)
  .then(data => {
    if (!data) return;

    if (data.nombres) $('nombres').value = data.nombres;
    if (data.apellido1) $('apellido1').value = data.apellido1;
    if (data.apellido2) $('apellido2').value = data.apellido2 || '';

    if (data.email) {
      $('email').value = data.email;
      $('email2').value = data.email;
    }

    if (data.telefono_movil) $('telefono').value = data.telefono_movil;
    if (data.pais) $('pais').value = data.pais;

    if (data.region) {
      const regionInput = document.getElementById('region');
      if (regionInput) regionInput.value = data.region;
    }
    if (data.ciudad) {
      const ciudadInput = document.getElementById('ciudad');
      if (ciudadInput) ciudadInput.value = data.ciudad;
    }
  })
  .catch(() => {});


  /* === Subtotal del paso anterior === */
  const totals = JSON.parse(sessionStorage.getItem('checkout_totals') || 'null');
  if (totals) $('subtotalStep3').textContent = money(totals.total);

  // === Mostrar/ocultar PATENTE según selección del Step-1 ===
  const payloadSel = JSON.parse(sessionStorage.getItem('checkout_payload') || 'null');
  const hasParking = !!(payloadSel && payloadSel.has_parking);
  const wrapPat = $('wrap-patente');
  const inpPat  = $('patente');

  function togglePatenteReq(){
    if (!wrapPat || !inpPat) return;
    if (hasParking) {
      wrapPat.style.display = '';
      inpPat.setAttribute('required','required');
    } else {
      wrapPat.style.display = 'none';
      inpPat.removeAttribute('required');
      inpPat.setCustomValidity('');
    }
  }
  togglePatenteReq();



  /* === Dependencias País -> Región -> Ciudad -> Comuna === */
  const regionesCL = [
    "Arica y Parinacota","Tarapacá","Antofagasta","Atacama","Coquimbo","Valparaíso",
    "Metropolitana de Santiago","O’Higgins","Maule","Ñuble","Biobío","La Araucanía",
    "Los Ríos","Los Lagos","Aysén","Magallanes"
  ];

  const comunasPorRegionCL = {
    "Metropolitana de Santiago": ["Santiago","Providencia","Maipú","Puente Alto","Ñuñoa","Las Condes","La Florida"],
    "Valparaíso": ["Valparaíso","Viña del Mar","Concón","Quilpué"],
    "Biobío": ["Concepción","Talcahuano","Coronel","Lota"],
    "Coquimbo": ["La Serena","Coquimbo"],
    "Maule": ["Talca","Curicó","Linares"],
    "Los Lagos": ["Puerto Montt","Osorno","Castro"],
    "Antofagasta": ["Antofagasta","Calama","Tocopilla"]
  };


  const selPais = $('pais'), wrapReg = $('wrap-region'), selRegion = $('region'),
        selCiudad = $('ciudad'), selComuna = $('comuna');

  function fillRegiones() {
    selRegion.innerHTML = '<option value="">— Selecciona —</option>';
    regionesCL.forEach(r => selRegion.append(new Option(r,r)));
  }
  function fillCiudades(region) {
    selCiudad.innerHTML = '<option value="">— Selecciona —</option>';
    (comunasPorRegionCL[region] || []).forEach(c => selCiudad.append(new Option(c,c)));
    selComuna.innerHTML = '<option value="">— Selecciona —</option>';
  }
  function fillComunas(ciudad) {
    selComuna.innerHTML = '<option value="">— Selecciona —</option>';
    selComuna.append(new Option(ciudad, ciudad)); // igual que ciudad (simplificado)
  }

  selPais.addEventListener('change', () => {
    if (selPais.value === 'CL') { wrapReg.style.display=''; fillRegiones(); }
    else { wrapReg.style.display='none'; selRegion.innerHTML='<option value="">— Selecciona —</option>'; }
    saveBuyer();
  });
  selRegion.addEventListener('change', () => { fillCiudades(selRegion.value); saveBuyer(); });
  selCiudad.addEventListener('change', () => { fillComunas(selCiudad.value); saveBuyer(); });
  selComuna.addEventListener('change', saveBuyer);

  /* === Persistencia + Prefill desde el perfil logeado === */
  const KEY = 'checkout_buyer';
  const fields = [
    'nombres','apellido1','apellido2','email','email2','telefono',
    'documento','pais','region','ciudad','comuna',
    'empresa','cargo','rubro','patente'
  ];

  function saveBuyer() {
    const data = {};
    fields.forEach(id => {
      const el = $(id);
      if (el) data[id] = el.value;
    });
    // lo guardamos en el mismo formato que ya usabas
    data.doc_tipo = $('doc_tipo_passport').checked ? 'passport' : 'rut';
    data.acepta_terms = $('acepta_terms').checked;
    data.acepta_news  = $('acepta_news').checked;
    sessionStorage.setItem(KEY, JSON.stringify(data));
  }

  function applyBuyerData(d) {
    if (!d) return;

    // rellenar inputs
    fields.forEach(id => {
      const el = $(id);
      if (el) el.value = d[id] || '';
    });

    // tipo documento
    const tipo = (d.doc_tipo || '').toLowerCase();
    if (tipo === 'passport' || tipo === 'pasaporte') {
      $('doc_tipo_passport').checked = true;
      $('doc_tipo_rut').checked = false;
    } else {
      $('doc_tipo_rut').checked = true;
      $('doc_tipo_passport').checked = false;
    }

    // checks
    $('acepta_terms').checked = !!d.acepta_terms;
    $('acepta_news').checked  = !!d.acepta_news;

    // región / ciudad / comuna de Chile
    if (d.pais === 'CL') {
      wrapReg.style.display = '';
      fillRegiones();
      if (d.region) {
        selRegion.value = d.region;
        fillCiudades(d.region);
      }
      if (d.ciudad) {
        selCiudad.value = d.ciudad;
        fillComunas(d.ciudad);
      }
      if (d.comuna) {
        selComuna.value = d.comuna;
      }
    }
  }

  function loadBuyer() {
    try {
      // 1º: lo que esté en sessionStorage (vuelve si el usuario ya rellenó)
      let d = JSON.parse(sessionStorage.getItem(KEY) || 'null');

      // 2º: si no hay nada, usamos los datos del perfil logeado
      if (!d && BUYER_FROM_SERVER) {
        d = BUYER_FROM_SERVER;
      }

      applyBuyerData(d);
    } catch (e) {
      console.error('Error cargando buyer:', e);
    }
  }

  /* === Validaciones suaves === */
  function validateSoft(){
    // reset (por si venía algo “pegado”)
    ['email','email2','telefono','documento','patente','region','ciudad','comuna','acepta_terms']
      .forEach(id => { const el = $(id); if (el) el.setCustomValidity(''); });

    // EMAIL formato + coincidencia
    const e1 = $('email'), e2 = $('email2');
    if (e1) {
      const emailFmtOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e1.value||'').trim());
      e1.setCustomValidity(emailFmtOk ? '' : 'Email inválido.');
    }
    if (e1 && e2) {
      const emailsOk = (e1.value||'').trim() && (e2.value||'').trim() && (e1.value.trim() === e2.value.trim());
      e2.setCustomValidity(emailsOk ? '' : 'Los emails no coinciden.');
    }

    // teléfono (>=8 dígitos)
    const tel = $('telefono');
    if (tel) tel.setCustomValidity(/^\d{8,}$/.test((tel.value||'').trim()) ? '' : 'Teléfono inválido.');

    // documento por tipo: RUT (módulo 11) o pasaporte
    const doc = $('documento');
    const isRut = $('doc_tipo_rut')?.checked;
    if (doc) {
      const valor = (doc.value || '').trim();
      if (isRut) {
        const okRut = validarRutChileno(valor);
        doc.setCustomValidity(okRut ? "" : "RUT inválido. Verifica el dígito verificador.");
      } else {
        const okPass = /^[A-Za-z0-9\-]{6,15}$/.test(valor);
        doc.setCustomValidity(okPass ? "" : "Número de documento inválido.");
      }
    }

    // país=CL → región/ciudad/comuna requeridas
    if (selPais.value === 'CL') {
      selRegion.required = true; selCiudad.required = true; selComuna.required = true;
    } else {
      selRegion.required = false; selCiudad.required = false; selComuna.required = false;
      selRegion.setCustomValidity(''); selCiudad.setCustomValidity(''); selComuna.setCustomValidity('');
    }

    // patente si compró estacionamiento
    if (hasParking && inpPat) {
      const okPat = /^[A-Za-z0-9\-]{4,8}$/.test((inpPat.value||'').trim());
      inpPat.setCustomValidity(okPat ? '' : 'Ingresa una patente válida.');
    }

    // términos
    const terms = $('acepta_terms');
    if (terms) terms.setCustomValidity(terms.checked ? '' : 'Debes aceptar.');

    pagar.disabled = !form.checkValidity();
    return form.checkValidity();
  }

  // Guardar en sessionStorage cada vez que el usuario escribe algo
  document.querySelectorAll('#checkoutForm input, #checkoutForm select').forEach(el => {
    el.addEventListener('input', () => { saveBuyer(); validateSoft(); });
    el.addEventListener('change', () => { saveBuyer(); validateSoft(); });
    el.addEventListener('blur',  () => { el.classList.add('touched'); validateSoft(); });
  });

  // Prefill inicial
  loadBuyer();
  validateSoft();

  // Formateo básico del documento (opcional, sin puntos)
  const docInput = $('documento');
  if (docInput) {
    docInput.addEventListener("input", () => {
      let v = docInput.value.toUpperCase().replace(/[^0-9K\-]/g,'');
      v = v.replace(/--+/g,'-');
      docInput.value = v;
    });
  }

    form.addEventListener('submit', e=>{
    e.preventDefault();

    const ok = validateSoft();
    form.classList.add('was-validated');
    if (!ok) return;

    // 1) Recupera el payload que ya tenías del Step 1
    const prev = JSON.parse(sessionStorage.getItem('checkout_payload')||'null');
    if(!prev){
      alert('No hay tickets seleccionados.');
      location.href = "{% url 'orders:public-checkout-step1' event.slug %}";
      return;
    }

    // 2) Arma el buyer CON TUS MISMOS CAMPOS
    const fields=['nombres','apellido1','apellido2','email','email2','telefono',
                  'documento','pais','region','ciudad','comuna','empresa','cargo',
                  'rubro','patente'];
    const buyer={};
    fields.forEach(id=> buyer[id] = document.getElementById(id)?.value || '');
    buyer.doc_tipo = document.getElementById('doc_tipo_rut')?.checked ? 'rut' : 'passport';
    buyer.acepta_terms = document.getElementById('acepta_terms')?.checked;
    buyer.acepta_news  = document.getElementById('acepta_news')?.checked;

    // 3) Mezcla buyer dentro del payload existente
    const merged = { ...prev, buyer };

    // Lo seguimos guardando en sessionStorage por si el usuario vuelve atrás
    sessionStorage.setItem('checkout_payload', JSON.stringify(merged));
    sessionStorage.setItem('checkout_buyer', JSON.stringify(buyer));

    // 4) Enviar TODO al servidor por POST (no con window.location.href)
    //    Creamos inputs ocultos con JSON
        // 4) Enviar el correo al servidor por POST a public_checkout_pay
    form.method = 'post';
    form.action = "{% url 'orders:public-checkout-pay' event.slug %}";

    // Creamos (o reutilizamos) un input oculto llamado "email"
    let emailHidden = document.querySelector('input[name="email"]');
    if (!emailHidden) {
      emailHidden = document.createElement('input');
      emailHidden.type = 'hidden';
      emailHidden.name = 'email';
      form.appendChild(emailHidden);
    }

    // Usamos el mismo valor del campo visible #email
    emailHidden.value = document.getElementById('email').value;

    form.submit();

  });


})();
</script>

{% endblock %}