{% extends "base.html" %}{% block title %}Validador{% endblock %}
{% block content %}
<style>
  :root{
    --ok:#d9fbe5; --ok-border:#2e7d32;
    --bad:#ffe1df; --bad-border:#c62828;
    --warn:#fff5cc; --warn-border:#b28704;
  }
  .wrap{max-width:900px;margin:auto}
  #code{font-size:28px;height:58px}
  .banner{margin-top:18px;padding:14px 16px;border-radius:10px;border:2px solid transparent;font-size:20px}
  .banner.ok{background:var(--ok);border-color:var(--ok-border)}
  .banner.bad{background:var(--bad);border-color:var(--bad-border)}
  .banner.warn{background:var(--warn);border-color:var(--warn-border)}
  .row-flex{display:flex;gap:10px;align-items:center;margin-top:10px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #ddd;font-size:13px}
  .muted{color:#666}
  .history{margin-top:18px}
  .history table{width:100%}
  .history td, .history th{padding:8px 6px;border-bottom:1px solid #eee;font-size:14px}
  .hcode{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
</style>

<div class="container container-int">

<div class="wrap">
  <h1>Validador de tickets</h1>
  <p class="muted">Escanea el c√≥digo o escribe y presiona Enter.</p>

  <input id="code" class="form-control" placeholder="pega/escanea c√≥digo" autofocus autocomplete="off" autocapitalize="off" spellcheck="false">

  <div class="row-flex">
    <button id="btn-full" class="btn btn-outline-secondary btn-sm">Pantalla completa</button>
    <label class="chip"><input type="checkbox" id="sound" checked> Sonido</label>
    <label class="chip"><input type="checkbox" id="big" checked> Alto contraste</label>
    <button id="btn-open-camera" class="btn btn-outline-primary btn-sm">
      Usar c√°mara (QR)
    </button>
  </div>

  <div id="camera-controls" style="display:none; margin-top:8px;">
    <div class="small mb-1">C√°mara:</div>
    <div id="camera-list" class="btn-group btn-group-sm" role="group">
      <!-- Ac√° JS va a inyectar los botones de cada c√°mara -->
    </div>
  </div>


  <div id="qr-wrapper" style="display:none; margin-top:12px;">
    <div id="qr-reader" style="max-width:400px; margin:0 auto;"></div>
    <p class="muted small" style="text-align:center; margin-top:6px;">
      Apunta la c√°mara al c√≥digo QR. Se validar√° autom√°ticamente.
    </p>
  </div>


  <div id="result" class="banner warn" style="display:none"></div>

  <div class="history">
    <h5>√öltimas lecturas</h5>
    <table>
      <thead><tr><th style="width:32%">C√≥digo</th><th>Estado</th><th>Hora</th><th>Evento</th></tr></thead>
      <tbody id="hist"></tbody>
    </table>
  </div>
</div>

</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>


<script>
/* ---------- CSRF ---------- */
function getCookie(name){
  const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');

/* ---------- UI helpers ---------- */
const $ = (q)=>document.querySelector(q);
const input = $('#code');
const out = $('#result');
const hist = $('#hist');
const soundOn = $('#sound');
const bigOn = $('#big');

function banner(cls, html){
  out.className = `banner ${cls}`;
  out.innerHTML = html;
  out.style.display = 'block';
}

/* Beeps con WebAudio (sin archivos) */
let actx = null;
function beep(freq=880, ms=120, type='sine'){
  if(!soundOn.checked) return;
  if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)();
  const o = actx.createOscillator(), g = actx.createGain();
  o.type = type; o.frequency.value = freq;
  o.connect(g); g.connect(actx.destination);
  g.gain.setValueAtTime(0.001, actx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.4, actx.currentTime+0.01);
  o.start();
  setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime+0.05); o.stop(actx.currentTime+0.06); }, ms);
}

function pushHistory(code, estado, evento){
  const tr = document.createElement('tr');
  const hh = new Date().toLocaleTimeString();
  tr.innerHTML = `<td class="hcode">${code}</td><td>${estado}</td><td>${hh}</td><td>${evento||'‚Äî'}</td>`;
  hist.prepend(tr);
  while(hist.children.length>5) hist.removeChild(hist.lastChild);
}

/* ---------- Validaci√≥n ---------- */
let lastCode = null, lastTs = 0;
async function validar(code){
  // Ignora doble lectura en 1.2s
  const now = Date.now();
  if(code===lastCode && (now-lastTs)<1200) return;
  lastCode = code; lastTs = now;

  banner('warn', 'Validando‚Ä¶'); beep(600,50,'triangle');

  try{
    const r = await fetch(`/orders/validate/${code}/`, {
      method:'POST',
      headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'fetch'}
    });
    const data = await r.json();

    if(r.ok){
      banner('ok', `‚úÖ <b>Ticket v√°lido</b> ‚Äî <b>${data.tipo}</b><br><small>${data.code}</small> ‚Äî <b>${data.evento}</b>`);

      document.body.style.background = bigOn.checked ? '#e7ffee' : '';
      beep(880,120,'square'); setTimeout(()=>beep(1175,120,'square'),120);
      pushHistory(code, '‚úÖ v√°lido', `${data.evento} ¬∑ ${data.tipo}`);
    }else{
      let msg = data.error === 'ALREADY_USED'
        ? `‚ö†Ô∏è <b>Ticket ya usado</b> ‚Äî <b>${data.tipo || ''}</b><br><small>${data.used_at}</small>`
        : '‚ùå <b>Ticket no v√°lido</b>';
      banner('bad', msg);
      document.body.style.background = bigOn.checked ? '#ffefef' : '';
      beep(220,220,'sawtooth');
      pushHistory(code, data.error==='ALREADY_USED' ? '‚ö†Ô∏è usado' : '‚ùå inv√°lido', `${data.evento || '‚Äî'} ¬∑ ${data.tipo || ''}`);
    }
  }catch(e){
    banner('warn','Problema de red'); document.body.style.background = '';
    pushHistory(code,'‚ö†Ô∏è red');
  }finally{
    setTimeout(()=>{ if(bigOn.checked) document.body.style.background=''; }, 1400);
  }
}

/* Enter para validar y detector por input (por si el lector no env√≠a Enter) */
input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    const code = input.value.trim();
    if(code){ validar(code); input.value=''; }
  }
});
const uuidRe=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
let autoT;
input.addEventListener('input', (e)=>{
  const v = e.target.value.trim();
  clearTimeout(autoT);
  autoT = setTimeout(()=>{
    if(uuidRe.test(v)){ validar(v); e.target.value=''; }
  }, 60);
});

/* Fokus persistente y pantalla completa */
setInterval(()=>{ if(document.activeElement!==input) input.focus(); }, 800);
$('#btn-full').onclick = ()=>{ const el=document.documentElement;
  if(!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
};


/* ---------- Escaneo de QR con c√°mara + selecci√≥n de dispositivo (botones) + MODO CONTINUO ---------- */
const btnOpenCamera  = document.getElementById("btn-open-camera");
const qrWrapper      = document.getElementById("qr-wrapper");
const cameraControls = document.getElementById("camera-controls");
const cameraList     = document.getElementById("camera-list");
const qrRegionId     = "qr-reader";

let html5QrCode      = null;
let isScanning       = false;
let cameras          = [];
let currentCameraId  = null;

// Para evitar leer el mismo c√≥digo muchas veces seguidas
let lastScannedCode  = null;
let lastScannedAt    = 0;

function setActiveCameraButton(camId) {
  if (!cameraList) return;
  [...cameraList.querySelectorAll("button")].forEach(btn => {
    if (btn.dataset.camId === camId) {
      btn.classList.add("btn-primary");
      btn.classList.remove("btn-outline-secondary");
    } else {
      btn.classList.remove("btn-primary");
      btn.classList.add("btn-outline-secondary");
    }
  });
}

function startScanner(cameraId) {
  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode(qrRegionId);
  }

  // si ya est√° escaneando, detener antes de cambiar de c√°mara
  if (isScanning) {
    html5QrCode.stop().then(() => {
      isScanning = false;
      html5QrCode.clear();
      runScanner(cameraId);
    }).catch(err => {
      console.error("Error al detener c√°mara:", err);
    });
  } else {
    runScanner(cameraId);
  }
}

function runScanner(cameraId) {
  html5QrCode.start(
    cameraId,
    {
      fps: 10,
      qrbox: { width: 250, height: 250 },
    },
    function onScanSuccess(decodedText, decodedResult) {
      const now = Date.now();

      // üîÅ Evitar validar el mismo c√≥digo muchas veces en muy poco tiempo
      if (decodedText === lastScannedCode && (now - lastScannedAt) < 1500) {
        return; // ignoramos esta lectura
      }

      lastScannedCode = decodedText;
      lastScannedAt   = now;

      // Aqu√≠ usas tu l√≥gica actual
      input.value = decodedText;
      validar(decodedText);
      input.value = "";

      // üëá IMPORTANTE: NO detener la c√°mara en modo continuo
      // Nada de html5QrCode.stop() aqu√≠
    },
    function onScanFailure(errorMessage) {
      // errores de lectura se ignoran, la c√°mara sigue
    }
  ).then(() => {
    isScanning = true;
    qrWrapper.style.display = "block";
    setActiveCameraButton(cameraId);
  }).catch(err => {
    console.error("No se pudo iniciar la c√°mara:", err);
    isScanning = false;
  });
}

if (btnOpenCamera) {
  btnOpenCamera.addEventListener("click", function () {
    // si ya cargamos las c√°maras antes:
    if (cameras.length > 0) {
      qrWrapper.style.display = "block";
      cameraControls.style.display = "block";
      if (!isScanning && currentCameraId) {
        startScanner(currentCameraId);
      }
      return;
    }

    // primera vez: pedimos las c√°maras al navegador
    Html5Qrcode.getCameras()
      .then(function (devices) {
        if (!devices || devices.length === 0) {
          alert("No se encontraron c√°maras disponibles.");
          return;
        }

        cameras = devices;
        cameraList.innerHTML = "";
        cameraControls.style.display = "block";
        qrWrapper.style.display = "block";

        // Elegimos por defecto:
        //  - si hay webcam USB, la tomamos
        //  - si no, la primera
        let defaultIndex = 0;
        devices.forEach((cam, index) => {
          const label = cam.label || "";
          if (label.toLowerCase().includes("usb") || label.toLowerCase().includes("webcam")) {
            defaultIndex = index;
          }
        });

        devices.forEach((cam, index) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-outline-secondary";
          btn.textContent = cam.label || `C√°mara ${index + 1}`;
          btn.dataset.camId = cam.id;

          btn.addEventListener("click", () => {
            if (cam.id !== currentCameraId) {
              currentCameraId = cam.id;
              startScanner(currentCameraId);
            }
          });

          cameraList.appendChild(btn);
        });

        currentCameraId = devices[defaultIndex].id;
        startScanner(currentCameraId);
      })
      .catch(function (err) {
        console.error("No se pudieron obtener las c√°maras:", err);
      });
  });
}



</script>
{% endblock %}
